@model IEnumerable<SportConnect.Models.Evento>

@using System.Security.Claims

@{
    int uid;
    bool logged = int.TryParse(User.FindFirstValue(ClaimTypes.NameIdentifier), out uid);
}


@{
    ViewData["Title"] = "Eventos";
}
@section HeadStyles {
    <style>
        [id^="map-"] {
            height: 250px !important;
            width: 100%;
            border-radius: 8px;
        }

        a:hover {
            text-decoration: none;
            color: #333;
        }


        .btn {
            margin-bottom: 20px;
            margin-top: 20px;
            border-radius: 12px;
            padding: 6px 12px;
        }
    </style>
}

<div class="container">

    <div class="header-controls">
        <a href="@Url.Action("Index", "Grupos")" class="btn " title="Voltar  para grupos">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
            </svg>

        </a>

        <h1>Eventos</h1>

        <div>
            @{
                var criadorId = ViewBag.CriadorDoGrupoId as int?;
                var podeGerenciar = criadorId.HasValue && criadorId.Value == uid;
            }

            @if (podeGerenciar)
            {
                <a href="@Url.Action("Create", "Eventos", new { grupoId = ViewBag.GrupoId })" class="btn btn-primary btn-custom">Criar novo evento</a>
            }
        </div>
    </div>


    <div class="row">

        @if (!Model.Any())
        {
            <div class="col-12">
                <div class="alert alert-info text-center" role="alert">
                    Ainda não há eventos cadastrados neste grupo.
                    @if (podeGerenciar)
                    {
                        <br>
                        @: Clique em "Criar novo evento" para começar!
                    }
                </div>
            </div>
        }

        @foreach (var item in Model)
        {
            <div class="col-md-4 mb-4">

                @{
                    var ehDono = logged
                    && item.CriadorId == uid;
                }

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">@item.Nome</h5>
                        <p class="card-text">
                            <strong>Descrição: </strong>@item.Descricao
                        </p>
                        <p class="card-text">
                            <strong>Data e Horário: </strong>@item.DataEvento.ToString("dd/MM/yyyy HH:mm")
                        </p>
                        <p class="card-text">
                            <strong>Endereço:</strong> @item.Rua,
                            @item.Numero - @item.Bairro, @item.Cidade
                        </p>

                        <div id="map-@item.Id" style="height: 200px; border-radius: 8px; background-color: #f0f0f0;"></div>
                        @if (ehDono)
                        {
                            <div class="mt-3">
                                <a class="btn btn-secondary" asp-action="Edit" asp-route-id="@item.Id" title="Editar">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325" />
                                    </svg>
                                </a>
                                <a class="btn btn-danger" asp-action="Delete" asp-route-id="@item.Id">Excluir</a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>
@section Scripts {
    @{

        // 1. Prepara a lista de dados apenas com ID e coordenadas
        var mapData = Model
      .Where(i => i.Latitude.HasValue && i.Longitude.HasValue)
      .Select(i => new
      {
          Id = i.Id,
          Lat = i.Latitude.Value.ToString(System.Globalization.CultureInfo.InvariantCulture),
          Lng = i.Longitude.Value.ToString(System.Globalization.CultureInfo.InvariantCulture),
          Nome = i.Nome,

          Endereco = $"{i.Rua}, {i.Numero} - {i.Bairro}, {i.Cidade}"
      });
        // 2. Serializa para uma string JSON pura
        var jsonMapData = Newtonsoft.Json.JsonConvert.SerializeObject(mapData);
    }

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Inicializando mapas Leaflet via JSON...");

            // 3. Injeta a string JSON e faz o parse no JavaScript
            var events = @Html.Raw(jsonMapData);

            events.forEach(function(item) {
                try {

                    var lat = parseFloat(item.Lat);
                    var lng = parseFloat(item.Lng);

                    if (isNaN(lat) || isNaN(lng)) {
                        console.error("Coordenadas inválidas para o evento " +
                        item.Nome);
                        return;
                    }

                    console.log("Evento '" + item.Nome + "' - Lat:", lat, "Lng:", lng);

                    var map = L.map('map-' + item.Id).setView([lat,
                    lng], 15);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);

                    L.marker([lat, lng])

                        .addTo(map)
                        .bindPopup("<b>" + item.Nome + "</b><br>" + item.Endereco);
                    setTimeout(function() {
                        map.invalidateSize();  
                    }, 400);
                } catch (e) {
                    console.error("Erro ao renderizar mapa do evento '" + item.Nome + "':", e);
                }
            });
        });
    </script>
}